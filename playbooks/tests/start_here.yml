---
- name: this Ansible Playbook will terminate un-tagged instances
  hosts: localhost
  gather_facts: false
  vars:
    ec2_region: "{{ your_region | default('us-east-1') }}"
    resource_prefix: "sean"
    ec2_ami_name: "amzn2-ami-hvm-2.*-x86_64-gp2"
    ec2_instance_tag_TestId: "sean-testing"
    testing_subnet_a:
      subnet:
        id:  "subnet-07054c7b1828c3f31"
  tasks:
    - run_once: '{{ setup_run_once | default("no") | bool }}'
      block:
      - name: "Find AMI to use"
        run_once: yes
        ec2_ami_info:
          owners: 'amazon'
          filters:
            name: '{{ ec2_ami_name }}'
        register: ec2_amis
      - name: "Set fact with latest AMI"
        run_once: yes
        vars:
          latest_ami: '{{ ec2_amis.images | sort(attribute="creation_date") | last }}'
        set_fact:
          ec2_ami_image: '{{ latest_ami.image_id }}'

    - name: run tasks
      include_tasks: "test_ec2_instance_info.yml"
